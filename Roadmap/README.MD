# Validated Calibration Road Map
**Goal: Apply validated calibration values to the appropriate data files.**

For active acoustic data to be quantitatively used for fisheries and ecosystem management, the data must be calibrated to an absolute standard, i.e., the standard sphere method [DOIs to Foote and Demer reports]. A calibration consists of measurements, fitting data to models, and finally generating values (e.g., gains, beam widths, angle offsets, etc.) that are applied to the data. It is incumbent on the data provider to verify and validate the calibration values and provide a data provenence so that the user of the data has confidence that the data are calibrated to the standards necessary for fisheries and ecosystem management. This document provides a roadmap for the provenence of the validated calibration values.  

NOAA collects data with a variety of active acoustic instrumentation and manufacturers and each have their own methods for storing and tracking calibration values. We start with the most commonly used systems and, hopefully, our methods are generic enough to accommodate other systems. There are many ways to store and track data. In our case, we start with a file that contains the calibration values, and this calibration file is matched to the appropriate data files. The calibration file is generated and validated once and becomes a static reference with permanent maps to the appropriate data files. Future developments will involve dynamic calibration references, e.g., using relational databases.  

This document is structured by instrument and manufacturer. Kongsberg/Simrad echosounders are the dominant systems used by NOAA Fisheries for more than 50 years and we start with them.

## Kongsberg
This section describes calibration parameters and files for the Kongsberg (aka Simarad) echosounders: EK500, EK60, and EK80. Other sounders will be added as we acquire data from them.

### EK500
The EK500 stores calibration values in a file that is read by the EK500 echosounder upon startup. The calibration values are not recorded in the data files. TBD


### EK60/ER60
Calibration values for EK60/ER60 data files are written to (i.e., embedded in) each data file. These values are not applied to the digitized-signal data (e.g., "power") in the file, but are applied by the processing software after the data have been read into the software. Not applying the calibration values to the data has benefits and limitations.  A benefit is that modifications to the calibration values can be made and applied in software in the event that the embedded values are incorrect. Limitations are that the data are not "calibrated" and can not be used directly by only reading the file, users not accustomed to Kongsberg data may not understand that they need to apply the calibration values to the data prior to analysis, and changes to the calibration values must be tracked throughout the lifecycle of the data file.

#### Channels
EK60/ER60 data files can contain data from multiple echosounders and transducers, and each echosounder can be configured in its own way. Kongsberg identifies each combination of transceiver-transducer pair and operational configuration as a "channel". The channel identification is a character string with space-delimited components that provide information about the configuration.   An example EK60/ER60 channel ID is:  
**GPT  18 kHz 009072034d45 1-1 ES18-11**
where the components are:
- "GPT": the transceiver identification. "GPT" is a General Purpose Transceiver (GPT).
  - The only sounder used by the EK60 system.
- "18": the transmitted acoustic frequency.
- "kHz": the units of the transmitted acoustic frequency. 
  - Combining the frequency value and units into one string is a convenient way to express the transmitted acoustic frequency.
- "009072034d45": Transceiver identification as generated by Kongsberg and the ER60 software.
- "1-1": Combination of a channel number and configuration, as defined by Kongsberg. 
  - The channel number is defined by the order in which each transceiver was installed in the ER60 acquisition software. 
  - The configuration is based on the acquisition settings.
  - NEED TO CONFIRM & PROVIDE MORE DETAILS.
- "ES18-11": The transducer model. 
  - This value is obtained from the installation menu, i.e., a transceiver-transducer pair are defined in the installation section of the ER60 acquisition software.

The "channel number - configuration ID" can change based on the installation order of the transceiver-transducer pair and configuration. While this can not change within a file, it can change among files. For example, a transceiver-transducer pair could be installed/reinstalled during a survey in an order that is different from the previous order. In this case, the same calibration values could/should be applied for different channel IDs.

### EK80
Calibration values for EK60/ER60 data files are written to (i.e., embedded in) each data file. These values are not applied to the digitized-signal data (e.g., "power") in the file, but are applied by the processing software after the data have been read into the software. Not applying the calibration values to the data has benefits and limitations.  A benefit is that modifications to the calibration values can be made and applied in software in the event that the embedded values are incorrect. Limitations are that the data are not "calibrated" and can not be used directly by only reading the file, users not accustomed to Kongsberg data may not understand that they need to apply the calibration values to the data prior to analysis, and changes to the calibration values must be tracked throughout the lifecycle of the data file.

#### Channels
EK80 data files can contain data from multiple echosounders and transducers, and each echosounder can be configured in its own way. Kongsberg identifies each combination of transceiver-transducer pair and operational configuration as a "channel". The channel identification is a character string with space-delimited components that provide information about the configuration.   An example EK80 channel ID is:  
**WBT 978217-15 ES38-7_1**
where the components are:
- "WBT": the transceiver identification. "WBT" is a Wide Band Transceiver (WBT). 
  - The EK80 acquisition software can also operate the EK60 General Purpose Transceiver (GPT).
- "978217015": Transceiver identification as generated by Kongsberg and the EK80 software.
- "ES38-7_1": A combination of the transducer model and configuration. 
  - The transducer model value is obtained from the installation menu, i.e., a transceiver-transducer pair are defined in the installation section of the EK80 acquisition software, and also provides the transmit frequency in kHz (e.g., the "38" indicates 38 kHz). 


### Common Calibration File Format
The validated calibration values are stored in a file, which provides a static reference to the validated values with permanent maps to the appropriate data files.  
We have selected the open data format, [yaml](https://yaml.org/) as our format.

#### Calibration File Naming Convention:
Because the file is a static reference, we need to have a naming convention that will be permanent, easily intepreted by humans and machine, and efficiently mapped to the data files. Kongsberg parses data files into channels (see "Channels" sections above), so we generate one file per channel. 
- DateID_ChannelID_calibration
  - DateID:
    - The calibration date: Dyyyymmdd-Thhmmss
  - ChannelID:
    - The full channel ID that matches the channel ID in the data file.
  - _calibration:
    - A consistent identifier that this is a calibration file.
Examples:
- D20140911-T073841_GPT  18 kHz 009072034d45 1-1 ES18-11_calibration.yml
- D20140911-T073841_WBT 978217-15 ES38-7_1_calibration.yml

#### Parameter Values:
The parameter values and nameing convention are detailed in the link to the JSON schema


### Implementation
Overarching Rules:
- Calibration values do not change within a file. 
  - The calibration values written for each channel are constant throughout the file.  
- Calibration values within a file are immutable. 
  - We do not overwrite the values within a file.
- We can modify calibration values for time periods within a data file after the file has been imported to the processing software.
- A channel ID is unique within a data file, but not necessarily among data files.
- The same calibration values can be used for different channel IDs.
- Map calibration values to a channel and data file.
  - <collection ID>
    - <data file ID>
      - <channel ID> : <SurveyID_DataFileID_ChannelID_calibration.yml>

General Workflow:
1. Select a set of data files to do something with.
1. Generate a list of unique collection IDs, file IDs, and channel IDs from the selected files.


- Stage 1
  - Select a set of data files to:
    - Upload the files to NCEI, e.g., using Tugboat
    - Upload the files to the AA-SI storage bucket
    - Download the files to local storage
    - Process & Analyze


